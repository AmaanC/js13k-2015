!function(e,t){"function"==typeof define&&define.amd?define(["exports"],t):"object"==typeof exports&&"string"!=typeof exports.nodeName?t(exports):t(e.TinyMusic={})}(this,function(e){function t(e){var n=e.split(a);this.frequency=t.getFrequency(n[0])||0,this.duration=t.getDuration(n[1])||0}function n(e,t,n){this.ac=e||new AudioContext,this.createFxNodes(),this.tempo=t||120,this.loop=!0,this.smoothing=0,this.staccato=0,this.notes=[],this.push.apply(this,n||[])}var r="B#-C|C#-Db|D|D#-Eb|E-Fb|E#-F|F#-Gb|G|G#-Ab|A|A#-Bb|B-Cb",i=440*Math.pow(Math.pow(2,1/12),-9),o=/^[0-9.]+$/,s=4,a=/\s+/,c=/(\d+)/,p={};r.split("|").forEach(function(e,t){e.split("-").forEach(function(e){p[e]=t})}),t.getFrequency=function(e){var t=e.split(c),n=p[t[0]],r=(t[1]||s)-s,o=i*Math.pow(Math.pow(2,1/12),n);return o*Math.pow(2,r)},t.getDuration=function(e){return o.test(e)?parseFloat(e):e.toLowerCase().split("").reduce(function(e,t){return e+("w"===t?4:"h"===t?2:"q"===t?1:"e"===t?.5:"s"===t?.25:0)},0)},n.prototype.createFxNodes=function(){var e=[["bass",100],["mid",1e3],["treble",2500]],t=this.gain=this.ac.createGain();return e.forEach(function(e,n){n=this[e[0]]=this.ac.createBiquadFilter(),n.type="peaking",n.frequency.value=e[1],t.connect(t=n)}.bind(this)),t.connect(this.ac.destination),this},n.prototype.push=function(){return Array.prototype.forEach.call(arguments,function(e){this.notes.push(e instanceof t?e:new t(e))}.bind(this)),this},n.prototype.createCustomWave=function(e,t){t||(t=e),this.waveType="custom",this.customWave=[new Float32Array(e),new Float32Array(t)]},n.prototype.createOscillator=function(){return this.stop(),this.osc=this.ac.createOscillator(),this.customWave?this.osc.setPeriodicWave(this.ac.createPeriodicWave.apply(this.ac,this.customWave)):this.osc.type=this.waveType||"square",this.osc.connect(this.gain),this},n.prototype.scheduleNote=function(e,t){var n=60/this.tempo*this.notes[e].duration,r=n*(1-(this.staccato||0));return this.setFrequency(this.notes[e].frequency,t),this.smoothing&&this.notes[e].frequency&&this.slide(e,t,r),this.setFrequency(0,t+r),t+n},n.prototype.getNextNote=function(e){return this.notes[e<this.notes.length-1?e+1:0]},n.prototype.getSlideStartDelay=function(e){return e-Math.min(e,60/this.tempo*this.smoothing)},n.prototype.slide=function(e,t,n){var r=this.getNextNote(e),i=this.getSlideStartDelay(n);return this.setFrequency(this.notes[e].frequency,t+i),this.rampFrequency(r.frequency,t+n),this},n.prototype.setFrequency=function(e,t){return this.osc.frequency.setValueAtTime(e,t),this},n.prototype.rampFrequency=function(e,t){return this.osc.frequency.linearRampToValueAtTime(e,t),this},n.prototype.play=function(e){return e="number"==typeof e?e:this.ac.currentTime,this.createOscillator(),this.osc.start(e),this.notes.forEach(function(t,n){e=this.scheduleNote(n,e)}.bind(this)),this.osc.stop(e),this.osc.onended=this.loop?this.play.bind(this,e):null,this},n.prototype.stop=function(){return this.osc&&(this.osc.onended=null,this.osc.disconnect(),this.osc=null),this},e.Note=t,e.Sequence=n}),function(e){var t={};t.default=["A1 e"],t.damage=["D1 q"],e.effects=t;var n=new AudioContext,r={};e.sfx=r,r.tempo=120,e.sfxLoader=function(e){var t=new TinyMusic.Sequence(n,r.tempo,e);t.loop=!1,t.play()}}(window.game),function(e){var t=new AudioContext,n=e.audio={};n.tempo=120,n.trackCount=12;var r={};r[0]=["A1 q","_  q","A1 q","_  q","A1 q","A2 q","A1 q","_  q","A1 q","_  q","A1 q","_  q","A1 q","A2 q","A1 q","_  q"];for(var i=[],o=0;o<n.trackCount;o++){var s=new TinyMusic.Sequence(t,n.tempo,r[o]);s.loop=!0,i.push(s)}i[0].smoothing=0,i[0].staccato=0,i[0].gain.gain.value=1,i[0].mid.frequency.value=800,i[0].mid.gain.value=3,i[0].bass.gain.value=6,i[0].bass.frequency.value=80,i[0].treble.gain.value=-2,i[0].treble.frequency.value=1400,e.startAudio=function(){for(var e=0;e<i.length;e++)i[e].play()},e.startStop=function(){for(var e=0;e<i.length;e++)i[e].stop()}}(window.game),function(e){{var t=e.canvas=document.getElementById("game");e.ctx=t.getContext("2d")}e.cx=t.width/2,e.cy=t.height/2;var n=function(){e.backgroundDraw(),e.playerDraw(),e.particleDraw(),e.enemyDraw(),requestAnimationFrame(n)},r=function(){e.backgroundLogic(),e.particleLogic(),e.enemyLogic(),setTimeout(r,100/6)},i=function(){n(),r()};window.addEventListener("load",i,!1)}(window.game),function(e){e.keys={},e.playerDirection=1;var t=function(t){"left"===t?e.turnPlayer(e.playerDirection):"right"===t&&e.turnPlayer(-e.playerDirection)};document.body.addEventListener("keydown",function(n){e.keys[n.keyCode]=!0,e.player.canMove&&(39===n.keyCode?t("left"):37===n.keyCode&&t("right"))}),document.body.addEventListener("keyup",function(t){e.keys[t.keyCode]=!1}),document.body.addEventListener("touchstart",function(n){n.changedTouches[0].pageX<e.cx?t("left"):t("right")})}(window.game),function(e){var t=e.ctx,n={};e.player=n,n.cx=e.cx,n.cy=e.cy,n.time=0,n.dist=40,n.halfBase=10,n.halfHeight=10,n.angle=0,n.canMove=!0,n.pos=0,n.skins={"default":"13, 213, 252",flashColor:"255, 184, 253"},n.color=n.skins.default,n.alpha=1,n.hideTemporarily=function(){n.alpha=0,setTimeout(function(){n.color=n.skins.default,n.alpha=1,e.currentState="complete"},1e3)},e.playerDraw=function(){var e=n.cx,r=n.cy,i=n.halfBase,o=n.halfHeight;t.save(),t.translate(e,r),t.rotate(n.angle),t.translate(n.dist+o,0),t.beginPath(),t.moveTo(-o,-i),t.lineTo(-o,i),t.lineTo(o,0),t.closePath(),t.restore(),t.lineWidth=5,t.lineJoin="round",t.strokeStyle="rgba("+n.color+", "+n.alpha+")",t.stroke(),t.fillStyle="rgba("+n.color+", 0)",t.fill(),t.shadowBlur=0},e.turnPlayer=function(t){n.pos+=t,n.pos>=e.sides&&(n.pos%=e.sides),n.pos<0&&(n.pos=e.sides+t),n.angle=e.turnStep*n.pos,n.restAngle=n.angle},e.reversePlayerControls=function(){e.playerDirection*=-1,e.ctx.globalCompositeOperation=e.playerDirection>0?"source-over":"difference"}}(window.game);var exports=window.game;exports.sides=4;var ticks=0,maxWait=20,spinAmount=2,enemies=[],enemyPositions=[],ENEMY_HEIGHT=50,ENEMY_WIDTH=20,DEFAULT_ENEMY_SPEED=10,SPEED_LIMIT=20,ENEMY_CENTER_DIST=500,MIN_ENEMIES=1,MIN_EMPTY_SPOTS=1,crusherEnemyIndex=-1,ODDS_OF_REVERSER=.15,difficultyLevel=1,numCrossed=0,enemySpeed=DEFAULT_ENEMY_SPEED,spinPlayer=!1,alreadySpunPlayer=!1,STEPS_TO_NEXT_LEVEL=2,HIT_PARTICLE_COLORS=["red"],NORMAL_ENEMY_COLOR="white",REVERSER_ENEMY_COLOR="green",WAIT_DIST=200,MOVE_IN_SPEED=5,CRUSH_SPEED=1,NUM_PARTICLES=3,PARTICLE_SPEED=1,PARTICLE_OFFSET=Math.PI/2,PARTICLE_RANGE=.2,SHAKE_INTENSITY=4;exports.turnStep=2*Math.PI/exports.sides,exports.currentState="complete",exports.changeSides=function(e){enemies=[],exports.currentState="complete",exports.sides=e,exports.turnStep=2*Math.PI/exports.sides,exports.player.pos=0,exports.player.angle=0,exports.player.restAngle=0,exports.initBackground()},exports.enemyDraw=function(){for(var e,t=exports.ctx,n=0;n<enemies.length;n++)e=enemies[n],t.save(),t.translate(exports.cx,exports.cy),t.rotate(e.angle),t.fillStyle=e.reverser?REVERSER_ENEMY_COLOR:NORMAL_ENEMY_COLOR,t.fillRect(e.centerDist,-ENEMY_HEIGHT/2,ENEMY_WIDTH,ENEMY_HEIGHT),t.restore()};var addEnemy=function(e){var t={};t.angle=e||0,t.centerDist=ENEMY_CENTER_DIST,t.reverser=Math.random()<ODDS_OF_REVERSER,t.time=0,enemies.push(t)},range=function(e,t){for(var n=[],r=e;t>r;r++)n.push(r);return n},makeEnemyWave=function(){for(var e=range(0,exports.sides),t=MIN_ENEMIES+Math.floor(Math.random()*(exports.sides-MIN_EMPTY_SPOTS-1)),n=0;t>n;n++)e.splice(Math.floor(Math.random()*e.length),1);for(n=0;n<e.length;n++)addEnemy(exports.turnStep*e[n]);return exports.currentState="movingIn",e},animateEnemies=function(e,t,n){for(var r=!0,i=0;i<enemies.length;i++)enemy=enemies[i],enemy.centerDist-=t||5,enemy.centerDist<=e?enemy.centerDist=e:r=!1;r&&n()},makePlayerSpin=function(e){exports.spinAnimate(exports.player,function(){exports.turnPlayer(exports.steps),exports.spinning=!1,exports.currentState=e})},playerHit=function(e){enemies[e].reverser&&exports.reversePlayerControls(),numCrossed=0,exports.currentState="crushing",exports.player.color=exports.player.skins.flashColor,setTimeout(function(){exports.player.color=exports.player.skins.default},100),exports.createParticles(Math.random()*NUM_PARTICLES+1,exports.cx,exports.cy,HIT_PARTICLE_COLORS,PARTICLE_SPEED,exports.player.angle+PARTICLE_OFFSET,PARTICLE_RANGE),exports.createParticles(Math.random()*NUM_PARTICLES+1,exports.cx,exports.cy,HIT_PARTICLE_COLORS,PARTICLE_SPEED,exports.player.angle-PARTICLE_OFFSET,PARTICLE_RANGE),exports.shakeScreen(SHAKE_INTENSITY)},increaseDifficulty=function(){switch(numCrossed++,numCrossed>STEPS_TO_NEXT_LEVEL&&(numCrossed=0,difficultyLevel++,exports.triggerSpin(exports.sides),enemies=[],exports.player.time=exports.NUM_SHAPES,exports.currentState="increasingDifficulty",console.log("Difficulty:",difficultyLevel)),difficultyLevel){case 2:enemySpeed+=(SPEED_LIMIT-DEFAULT_ENEMY_SPEED)/STEPS_TO_NEXT_LEVEL;break;case 3:spinPlayer=!0;break;case 4:exports.changeSides(exports.sides+1),exports.currentState="increasingDifficulty",exports.triggerSpin(exports.sides),difficultyLevel=1,enemySpeed=DEFAULT_ENEMY_SPEED,spinPlayer=!1}};exports.enemyLogic=function(){switch(exports.currentState){case"complete":exports.player.canMove=!0,alreadySpunPlayer=!1,enemies=[],enemyPositions=makeEnemyWave();break;case"movingIn":animateEnemies(WAIT_DIST,MOVE_IN_SPEED,function(){exports.currentState="waiting"});break;case"waiting":ticks++,ticks>maxWait&&(ticks=0,exports.currentState="attacking",spinPlayer&&(exports.triggerSpin(spinAmount),exports.player.time=exports.NUM_SHAPES,exports.currentState="spinning",exports.player.canMove=!1));break;case"spinning":exports.spinning&&makePlayerSpin("attacking");break;case"attacking":exports.player.canMove=!0,animateEnemies(exports.player.dist,enemySpeed,function(){crusherEnemyIndex=enemyPositions.indexOf(exports.player.pos),-1!=crusherEnemyIndex?playerHit(crusherEnemyIndex):(exports.currentState="complete",increaseDifficulty())});break;case"crushing":exports.player.canMove=!1,animateEnemies(exports.player.dist,CRUSH_SPEED,function(){exports.player.hideTemporarily()});break;case"increasingDifficulty":exports.player.canMove=!1,makePlayerSpin("complete"),exports.allShapesDoneSpinning&&(exports.currentState="complete")}},function(e){e.shakeScreen=function(){var t=function(){return Math.random()>.5?1:-1},n=0,r=0;return function(i){var o=e.ctx;0===n&&o.save(),i||(i=2);var s=Math.random()*i*t(),a=Math.random()*i*t();return n+=s,r+=a,.2>i%2&&(o.translate(-n,-r),n=r=0,.15>=i)?(o.restore(),!0):(o.translate(s,a),setTimeout(function(){e.shakeScreen(i-.1)},5),void 0)}}(),e.createParticles=function(){var t=[],n=7,r=7,i=.02;e.particleDraw=function(){for(var e=0;e<t.length;e++)t[e].draw()},e.particleLogic=function(){for(var e=t.length;e--;)t[e].logic(),t[e].alive===!1&&t.splice(e,1)};var o=function(o,s,a,c,p){var l={};l.x=o,l.y=s,l.speed=a||5,l.color=c||"black",l.angle=p||0,l.opacity=1,l.decRate=i,l.dx=Math.cos(l.angle)*l.speed,l.dy=Math.sin(l.angle)*l.speed;var u=e.ctx;l.draw=function(){u.save(),u.globalAlpha=this.opacity,u.globalCompositeOperation="lighter",u.translate(this.x,this.y),u.rotate(e.player.angle),u.fillStyle=this.color||"red",u.fillRect(e.player.dist,0,n,r),u.restore()},l.logic=function(){this.x+=this.dx,this.y+=this.dy,this.opacity-=this.decRate,this.opacity<=0&&(this.opacity=0,this.alive=!1)},t.push(l)};return function(e,t,n,r,i,s,a){for(var c=0;e>c;c++)o(t,n,i,r[Math.floor(Math.random()*r.length)],s-a+2*Math.random()*a)}}()}(window.game),function(e){var t=[],n=e.ctx,r=["#BF0C43","#F9BA15","#8EAC00","#127A97","#452B72"],i=2*e.player.dist,o=50;e.NUM_SHAPES=20,e.steps=1,e.allShapesDoneSpinning=!0;var s=function(e,t,n,r){return e/=r/2,1>e?n/2*e*e+t:(e--,-n/2*(e*(e-2)-1)+t)},a=function(t,r,i,o,s){var a=i/(2*Math.cos(e.turnStep/2));n.beginPath(),n.moveTo(t+a*Math.cos(o),r+a*Math.sin(o));for(var c=1;c<=e.sides;c++)n.lineTo(t+a*Math.cos(o+2*Math.PI*c/e.sides),r+a*Math.sin(o+2*Math.PI*c/e.sides));n.closePath(),n.fillStyle=s||"green",n.fill()},c=70;e.spinAnimate=function(t,n){t.time++,"undefined"==typeof t.restAngle&&(t.restAngle=t.angle),t.angle=s(t.time,t.restAngle,e.steps*e.turnStep,e.steps*c),t.time>c*e.steps&&(t.angle=(t.restAngle+e.turnStep*e.steps)%(2*Math.PI),t.time=0,t.spinning=!1,n&&n())};var p=function(t,n,r,i){var o={};return o.x=t,o.y=n,o.side=r,o.restAngle=Math.PI/e.sides,o.angle=o.restAngle,o.color=i,o.time=0,o.draw=function(){a(o.x,o.y,o.side,o.angle,o.color)},o.logic=function(){e.spinAnimate(o)},o};e.initBackground=function(){t=[];for(var n=r,s=e.NUM_SHAPES-1;s>=0;s--)t.push(p(e.cx,e.cy,i+s*o,n[s%n.length]))},e.triggerSpin=function(n){var r;e.steps=n,e.spinning=!0;for(var i=0;i<t.length;i++)r=t[i],r.spinning=!0,r.time=i},e.backgroundDraw=function(){for(var e=0;e<t.length;e++)t[e].draw()},e.backgroundLogic=function(){e.allShapesDoneSpinning=!0;for(var n=0;n<t.length;n++)t[n].spinning&&(e.allShapesDoneSpinning=!1,t[n].logic())},e.initBackground()}(window.game);